<UserControl x:Class="GoogleCloudExtension.StackdriverErrorReporting.ErrorReportingDetailToolWindowControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:control="clr-namespace:GoogleCloudExtension.Controls"     
             xmlns:local="clr-namespace:GoogleCloudExtension.StackdriverErrorReporting"
             xmlns:utils="clr-namespace:GoogleCloudExtension.Utils;assembly=GoogleCloudExtension.Utils"       
             xmlns:mp="clr-namespace:GoogleCloudExtension.Extensions"                                  
             Background="{DynamicResource VsBrush.Window}"
             Foreground="{DynamicResource VsBrush.WindowText}"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800"
             d:DataContext="{d:DesignInstance IsDesignTimeCreatable=True,Type=local:ErrorReportingDetailViewModel}" >

<UserControl.Resources>
    <ResourceDictionary>
        <ResourceDictionary.MergedDictionaries>
            <ResourceDictionary Source="../Theming/CommonResources.xaml" />
        </ResourceDictionary.MergedDictionaries>

        <utils:VisibilityConverter x:Key="visibilityConverterNegated" IsNegated="True"/>
        <utils:VisibilityConverter x:Key="visibilityConverter" />

            <Style x:Key="cellStyle" TargetType="DataGridCell">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DataGridCell">
                        <Border  BorderThickness="0">
                            <Border x:Name="border" Padding="0, 4, 0, 4" >
                                <ContentPresenter />
                            </Border>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="rowStyle" TargetType="DataGridRow">
            <Setter Property="TextBlock.TextWrapping" Value="NoWrap" />
            <Setter Property="TextBlock.FontSize" Value="12" />
            <Setter Property="BorderThickness" Value="0, 0, 0, 1"/>
            <Setter Property="BorderBrush" Value="LightGray" />
            <Setter Property="Background" Value="#FFFDFDFD" />
            <Style.Triggers>
                <Trigger Property="AlternationIndex" Value="1">
                    <Setter Property="Background" Value="#F5F5F5"/>
                </Trigger>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#FFFFD6" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="BorderCommonStyle" TargetType="Border" >
            <Setter Property="BorderBrush" Value="LightGray" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Margin" Value="0, 6, 0, 6" />
        </Style>

            <Style x:Key="backToOverviewButtonStyle" TargetType="control:ImageToggleButton" >
                <Setter Property="HorizontalAlignment" Value="Left" />
                <Setter Property="VerticalAlignment" Value="Center" />
                <Setter Property="Padding" Value="6" />
                <Setter Property="Foreground" Value="#FF3B78E7" />
                <Setter Property="MouseOverForeground" Value="BlueViolet" />
                <Setter Property="Content" Value="To overview window" />
                <EventSetter Event="Click" Handler="LinkButton_Click"/>
            </Style>
                   
        </ResourceDictionary>
</UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        
        <control:TitleBar Grid.Row="0"/>

        <StackPanel
            Grid.Row="1"
            x:Name="_emptyAccountBlock"
            Margin="12"
            VerticalAlignment="Top"                
            HorizontalAlignment="Center"
            Visibility="{Binding IsAccountReset, Converter={StaticResource visibilityConverter}}"
            >
            
            <TextBlock Margin="6">Go to overview window and select an error group</TextBlock>
            <control:ImageToggleButton 
                FontSize="16"
                Style="{StaticResource backToOverviewButtonStyle}" 
                CheckedImage="{mp:ImageResource StackdriverErrorReporting/Resources/back_icon.png}"
                UncheckedImage="{mp:ImageResource StackdriverErrorReporting/Resources/back_icon.png}" />
            
        </StackPanel>

        <Grid 
            Grid.Row="1"
            Margin="12, 0, 12, 12" x:Name="_contentGrid"
              Visibility="{Binding IsAccountReset, Converter={StaticResource visibilityConverterNegated}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <Border 
                Grid.Row="0"
                Padding="0, 6, 0, 6"
                BorderThickness="0, 0, 0, 1"    
                BorderBrush="LightGray"
                IsEnabled="{Binding IsLoadingComplete}">

                <StackPanel  Orientation="Horizontal">
                    <control:ImageToggleButton 
                        Style="{StaticResource backToOverviewButtonStyle}" 
                        CheckedImage="{mp:ImageResource StackdriverErrorReporting/Resources/back_icon_12.png}"
                        UncheckedImage="{mp:ImageResource StackdriverErrorReporting/Resources/back_icon_12.png}" />

                    <local:AutoReloadButton                 
                        Margin="12, 0, 0, 0"
                        x:Name="autoReloadToggleButton"/>
                </StackPanel>
            </Border>

        <ScrollViewer 
            Grid.Row="1" 
            HorizontalScrollBarVisibility="Disabled"    
            VerticalScrollBarVisibility="Auto" >

          <StackPanel>
            
                <!-- buttons -->
                <Grid 
                    Margin="0, 12, 0, 12" 
                    IsEnabled="{Binding IsControlEnabled}" >
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBlock 
                        Grid.Column="0"                
                        Margin="0, 0, 36, 0"
                        FontWeight="DemiBold"
                        Text="{Binding Message}"
                        Style="{StaticResource CommonTextStyle}" />

                        <local:TimeRangeButtons 
                        Grid.Column="1" 
                        DataContext="{Binding TimeRangeButtonsModel}" />
                </Grid>


                <!-- Exception Box. -->
                <TextBox 
                    Panel.ZIndex="15"
                    Padding="8, 5, 8, 5" 
                    VerticalAlignment="Top"
                    HorizontalAlignment="Stretch"
                    TextAlignment="Left" 
                    TextWrapping="Wrap"
                    Foreground="Red" 
                    Text="{Binding ExceptionString, Mode=OneWay}" 
                    Visibility="{Binding ShowException, Converter={utils:VisibilityConverter}}" 
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    IsReadOnly="True" />

                <StackPanel Visibility="{Binding ShowException, Converter={utils:VisibilityConverter IsNegated=True}}" >

                    <!-- summary  -->
                    <Border 
                        Style="{StaticResource BorderCommonStyle}"
                        DataContext="{Binding GroupItem}"
                        Padding="12, 12, 12, 6">

                            <Grid>

                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" SharedSizeGroup="A" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*"  SharedSizeGroup="A" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*"  SharedSizeGroup="A" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" SharedSizeGroup="A" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" SharedSizeGroup="A" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" SharedSizeGroup="A" />
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0">
                                    <StackPanel >
                                        <TextBlock Text="Occurances" />
                                        <TextBlock Text="{Binding Count}" />
                                    </StackPanel>
                                </Border>
                                
                                <Border Grid.Column="1"/>

                                <Border 
                                    Grid.Column="2" 
                                    BorderThickness="1, 0, 0, 0"
                                    BorderBrush="LightGray"
                                    Padding="6, 0, 12, 0"                                     
                                    Visibility="{Binding AffectedUsersCount, Converter={utils:NullEmptyInvisibleConverter}}">
                                    <StackPanel>
                                        <TextBlock Text="Users affected" />
                                        <TextBlock Text="{Binding AffectedUsersCount}" />
                                    </StackPanel>
                                </Border>

                                <Border Grid.Column="3" Visibility="{Binding AffectedUsersCount, Converter={utils:NullEmptyInvisibleConverter}}" />

                                <Border 
                                    Grid.Column="4"
                                    BorderThickness="1, 0, 0, 0"
                                    BorderBrush="LightGray"
                                    Padding="6, 0, 0, 0">
                                    <StackPanel>
                                        <TextBlock Text="Seen in" />
                                        <TextBlock Text="{Binding SeenIn}" 
                                                   TextWrapping="Wrap"
                                                   MaxWidth="360" />
                                    </StackPanel>
                                </Border>
                                
                                <Border Grid.Column="5"/>

                                <Border 
                                    Grid.Column="6"
                                    BorderThickness="1, 0, 0, 0"
                                    BorderBrush="LightGray"
                                    Padding="6, 0, 12, 0" 
                                    Visibility="{Binding Status, Converter={utils:NullEmptyInvisibleConverter}}">
                                    <StackPanel>
                                        <TextBlock Text="Status" />
                                        <TextBlock Text="{Binding Status}" />
                                    </StackPanel>
                                </Border>

                                <Border Grid.Column="7" Visibility="{Binding Status, Converter={utils:NullEmptyInvisibleConverter}}"/>

                                <Border 
                                    Grid.Column="8"
                                    BorderThickness="1, 0, 0, 0"
                                    BorderBrush="LightGray"
                                    Padding="6, 0, 0, 0">
                                    <StackPanel>
                                        <TextBlock Text="First seen" />
                                        <TextBlock Text="{Binding FirstSeen}" />
                                    </StackPanel>
                                </Border>

                                <Border Grid.Column="9"/>

                                <Border 
                                    Grid.Column="10"
                                    BorderThickness="1, 0, 0, 0"
                                    BorderBrush="LightGray"
                                    Padding="6, 0, 0, 0" >
                                    <StackPanel>
                                        <TextBlock Text="Last seen" />
                                        <TextBlock Text="{Binding LastSeen}" />
                                    </StackPanel>
                                </Border>

                                <Border Grid.Column="11" />
                            </Grid>
                        </Border>

                    <!-- chart and progress indicator. -->
                    <Border Style="{StaticResource BorderCommonStyle}" 
                            MinHeight="180">

                        <Grid>

                            <control:ProgressIndicator 
                                Panel.ZIndex="20"
                                HorizontalAlignment="Center"                       
                                VerticalAlignment="Top" 
                                FullDuration="1000" 
                                Margin="6"
                                Visibility="{Binding IsGroupLoading, Converter={utils:VisibilityConverter}}" />

                            <local:TimedCountBarChart 
                                Panel.ZIndex="10"
                                DataContext="{Binding BarChartModel}" />
                        </Grid>

                    </Border>

                    <!-- stack trace sample -->
                    <Border Style="{StaticResource BorderCommonStyle}" >
                        <StackPanel Margin="6">

                            <control:ImageToggleButton  
                                Padding="6"
                                UncheckedImage="{mp:ImageResource StackdriverErrorReporting/Resources/show_more_icon.png}"
                                CheckedImage="{mp:ImageResource StackdriverErrorReporting/Resources/show_less_icon.png}" 
                                x:Name="traceSampleToggle"
                                HorizontalAlignment="Left"
                                IsChecked="True" >
                                Stack trace sample
                            </control:ImageToggleButton>

                            <TextBox 
                                BorderThickness="0"
                                Padding="8, 5, 8, 5"
                                Text="{Binding Stack, Mode=OneWay}" 
                                IsReadOnly="True"
                                AcceptsReturn="True"
                                TextWrapping="NoWrap"
                                HorizontalScrollBarVisibility="Auto"
                                Visibility="{Binding IsChecked, ElementName=traceSampleToggle, 
                                Converter={StaticResource visibilityConverter}}" />

                        </StackPanel>
                    </Border>

                    <!-- Recent samples. -->
                    <StackPanel Margin="12, 12, 0, 6">

                        <TextBlock Text="Recent Samples" Style="{StaticResource CommonTextStyle}" Padding="0, 6, 0, 6"/>

                        <Grid>
                            <control:ProgressIndicator 
                                Panel.ZIndex="20"
                                Margin="0, 20"
                                HorizontalAlignment="Center"                       
                                VerticalAlignment="Top" 
                                FullDuration="1000" 
                                Visibility="{Binding IsEventLoading, Converter={StaticResource visibilityConverter}}" />

                            <DataGrid 
                                Panel.ZIndex="10"
                                x:Name="DataGridEvents" 
                                VerticalScrollBarVisibility="Disabled"
                                ItemsSource="{Binding EventItemCollection}"
                                AutoGenerateColumns="False" 
                                IsReadOnly="True" 
                                HeadersVisibility="Column"    
                                ColumnHeaderHeight="10"                   
                                AlternationCount="2" 
                                GridLinesVisibility="None" 
                                CellStyle="{StaticResource cellStyle}"
                                RowStyle="{StaticResource rowStyle}"
                                BorderThickness="0"
                                PreviewMouseDown="dataGrid_PreviewMouseDown"
                                PreviewMouseWheel="dataGrid_PreviewMouseWheel"
                                >
                                <DataGrid.Resources>
                                    <SolidColorBrush x:Key="{x:Static SystemColors.HighlightTextBrushKey}" 
                                                    Color="Black"/>
                                </DataGrid.Resources>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Binding="{Binding EventTime}" />
                                    <DataGridTextColumn Binding="{Binding SummaryMessage}" />
                                </DataGrid.Columns>
                                <DataGrid.RowDetailsTemplate>
                                    <DataTemplate>
                                        <!-- Use a border to set the background. -->
                                        <Border Background="White" Padding="12, 0, 0 , 2">
                                            <TextBlock Text="{Binding Message}" />
                                        </Border>
                                    </DataTemplate>
                                </DataGrid.RowDetailsTemplate>
                            </DataGrid>
                        </Grid>
                    </StackPanel>

                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Grid>
    </Grid>
</UserControl>
